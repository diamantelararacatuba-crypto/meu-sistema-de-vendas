<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira e Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        /* Estilos CSS gerais */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        h1, h2 {
            font-weight: 700;
            color: #111827;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        input, select, textarea {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        
        /* Estilos para o modal de feedback */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background-color: #f9fafb;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .action-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-8">

    <div class="container">
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-indigo-800">Sistema de Gest√£o</h1>
            <p class="mt-4 text-xl text-gray-600">
                Escolha uma a√ß√£o para come√ßar.
            </p>
        </header>

        <!-- Se√ß√£o de Bot√µes Principais -->
        <section id="main-menu" class="card mb-12">
            <h2 class="text-2xl font-bold mb-6 text-center">Menu Principal</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <button class="action-button" data-target="section-add-client">
                    <span class="text-4xl">üë®‚Äçüíª</span>
                    <span class="mt-2 text-lg font-semibold">Cadastrar Cliente</span>
                </button>
                <button class="action-button" data-target="section-client-list">
                    <span class="text-4xl">üë•</span>
                    <span class="mt-2 text-lg font-semibold">Ver Clientes</span>
                </button>
                <button class="action-button" data-target="section-sales">
                    <span class="text-4xl">üìà</span>
                    <span class="mt-2 text-lg font-semibold">Vendas e Promiss√≥rias</span>
                </button>
                <button class="action-button" data-target="section-upcoming-dues">
                    <span class="text-4xl">üìÖ</span>
                    <span class="mt-2 text-lg font-semibold">Pr√≥ximos Vencimentos</span>
                </button>
                <button class="action-button" data-target="section-stock">
                    <span class="text-4xl">üì¶</span>
                    <span class="mt-2 text-lg font-semibold">Controle de Estoque</span>
                </button>
                <button class="action-button" data-target="section-payment">
                    <span class="text-4xl">üí∞</span>
                    <span class="mt-2 text-lg font-semibold">Registrar Pagamento</span>
                </button>
                <button class="action-button" data-target="section-invoice-entry">
                    <span class="text-4xl">üìÑ</span>
                    <span class="mt-2 text-lg font-semibold">Entrada de Nota Fiscal</span>
                </button>
            </div>
        </section>

        <!-- Se√ß√µes de Conte√∫do (Inicialmente ocultas) -->
        <div id="content-sections" class="hidden">
            <!-- Bot√£o de Voltar ao Menu -->
            <button id="backToMenuBtn" class="btn btn-secondary mb-8">‚Üê Voltar ao Menu</button>

            <!-- Se√ß√£o: Cadastrar Cliente -->
            <section id="section-add-client" class="card mb-12 hidden">
                <h2 class="text-2xl font-bold mb-6">Cadastro de Clientes</h2>
                <p class="text-sm text-gray-500 mb-4">Adicione novos clientes que ainda n√£o est√£o no sistema com todos os dados.</p>
                <form id="addClientForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label>
                        <input type="text" id="clientName" name="clientName" required class="w-full">
                    </div>
                    <div>
                        <label for="clientRG" class="block text-sm font-medium text-gray-700 mb-1">RG</label>
                        <input type="text" id="clientRG" name="clientRG" required class="w-full" placeholder="00.000.000-0">
                    </div>
                    <div>
                        <label for="clientCPF" class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                        <input type="text" id="clientCPF" name="clientCPF" required class="w-full" placeholder="000.000.000-00">
                    </div>
                    <div>
                        <label for="clientPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <input type="text" id="clientPhone" name="clientPhone" required class="w-full" placeholder="(DD) 99999-9999">
                    </div>
                    <!-- Nova linha para Rua, N√∫mero e Complemento -->
                    <div class="sm:col-span-2">
                        <label for="clientStreet" class="block text-sm font-medium text-gray-700 mb-1">Rua</label>
                        <input type="text" id="clientStreet" name="clientStreet" required class="w-full">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="clientNumber" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero</label>
                            <input type="text" id="clientNumber" name="clientNumber" required class="w-full">
                        </div>
                        <div>
                            <label for="clientComplement" class="block text-sm font-medium text-gray-700 mb-1">Complemento</label>
                            <input type="text" id="clientComplement" name="clientComplement" class="w-full">
                        </div>
                    </div>
                    <div>
                        <label for="clientNeighborhood" class="block text-sm font-medium text-gray-700 mb-1">Bairro</label>
                        <input type="text" id="clientNeighborhood" name="clientNeighborhood" required class="w-full">
                    </div>
                    <div>
                        <label for="clientCity" class="block text-sm font-medium text-gray-700 mb-1">Cidade</label>
                        <input type="text" id="clientCity" name="clientCity" required class="w-full">
                    </div>
                    <div class="flex items-end sm:col-span-2">
                        <button type="submit" class="btn btn-primary w-full">Cadastrar Cliente</button>
                    </div>
                </form>
            </section>

            <!-- Se√ß√£o: Carteira de Clientes -->
            <section id="section-client-list" class="card mb-12 hidden">
                <h2 class="text-2xl font-bold mb-6">Carteira de Clientes</h2>
                <!-- Nova se√ß√£o de filtro para clientes com saldo -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="clientCityFilterSelect" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Cidade</label>
                        <select id="clientCityFilterSelect" class="w-full">
                            <option value="">Todas as Cidades</option>
                        </select>
                    </div>
                    <div>
                        <label for="clientBalanceFilterSelect" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Saldo</label>
                        <select id="clientBalanceFilterSelect" class="w-full">
                            <option value="all">Todos os Clientes</option>
                            <option value="due">Clientes com Saldo a Pagar</option>
                            <option value="paid">Clientes com Saldo Pago</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Endere√ßo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cidade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Nova Tabela: Clientes com Vencimentos Pr√≥ximos -->
                <h3 class="text-xl font-bold mt-8 mb-4">Clientes com Vencimentos Pr√≥ximos</h3>
                <p class="text-sm text-gray-500 mb-4">Clientes que possuem uma ou mais promiss√≥rias com vencimento nos pr√≥ximos 30 dias.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="upcomingClientsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Se√ß√£o: Vendas e Promiss√≥rias -->
            <section id="section-sales" class="card mb-12 hidden">
                <h2 class="text-2xl font-bold mb-6">Consultar Vendas e Promiss√≥rias</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="clientFilterSelect" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Cliente</label>
                        <select id="clientFilterSelect" class="w-full">
                            <option value="">Todos os Clientes</option>
                        </select>
                    </div>
                    <div>
                        <label for="cityFilterSelect" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Cidade</label>
                        <select id="cityFilterSelect" class="w-full">
                            <option value="">Todas as Cidades</option>
                        </select>
                    </div>
                </div>
                
                <div id="salesListContainer" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∫ NF/Recibo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Vencimento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo a Pagar</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="allSalesTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Se√ß√£o: Pr√≥ximos Vencimentos -->
            <section id="section-upcoming-dues" class="card mb-12 hidden">
                <h2 class="text-2xl font-bold mb-6">Pr√≥ximos Vencimentos</h2>
                <p class="text-sm text-gray-500 mb-4">Promiss√≥rias com vencimento nos pr√≥ximos 30 dias.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∫ NF/Recibo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Vencimento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="upcomingDuesTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Se√ß√£o: Estoque -->
            <section id="section-stock" class="card mb-12 hidden">
                <h2 class="text-2xl font-bold mb-6">Controle de Estoque</h2>
                <!-- Formul√°rio de Cadastro de Produtos -->
                <h3 class="text-xl font-bold mb-4 mt-6">Cadastro de Produtos</h3>
                <p class="text-sm text-gray-500 mb-4">
                    Adicione novos produtos ao estoque. O c√≥digo √© opcional.
                </p>
                <form id="addProductForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label for="productCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="productCategory" name="productCategory" required class="w-full">
                            <option value="Para Casa">Produtos para Casa</option>
                            <option value="Aliment√≠cio">Produtos Aliment√≠cios</option>
                        </select>
                    </div>
                    <div>
                        <label for="productCode" class="block text-sm font-medium text-gray-700 mb-1">C√≥digo do Produto (Opcional)</label>
                        <input type="text" id="productCode" name="productCode" class="w-full">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <input type="text" id="productDescription" name="productDescription" required class="w-full">
                    </div>
                    <div>
                        <label for="productStock" class="block text-sm font-medium text-gray-700 mb-1">Estoque Inicial</label>
                        <input type="number" id="productStock" name="productStock" min="0" required class="w-full">
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo (R$)</label>
                        <input type="number" id="productPrice" name="productPrice" step="0.01" min="0" required class="w-full">
                    </div>
                    <div class="sm:col-span-2 flex justify-end">
                        <button type="submit" class="btn btn-primary w-full">Adicionar Produto</button>
                    </div>
                </form>

                <!-- Nova Se√ß√£o: Sa√≠da Manual de Produto -->
                <h3 class="text-xl font-bold mb-4 mt-6">Sa√≠da Manual de Produto</h3>
                <p class="text-sm text-gray-500 mb-4">
                    Retire produtos do estoque para a montagem de cestas ou para outros fins.
                </p>
                <form id="removeProductForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label for="removeProductSelect" class="block text-sm font-medium text-gray-700 mb-1">Selecione o Produto</label>
                        <select id="removeProductSelect" name="productCode" required class="w-full">
                            <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                            <option value="">Selecione um produto</option>
                        </select>
                    </div>
                    <div>
                        <label for="removeQuantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade a Retirar</label>
                        <input type="number" id="removeQuantity" name="quantity" min="1" required class="w-full">
                    </div>
                    <div class="sm:col-span-2 flex justify-end">
                        <button type="submit" class="btn btn-primary w-full">Retirar do Estoque</button>
                    </div>
                </form>

                <!-- Tabelas de Estoque Separadas por Categoria -->
                <h3 class="text-xl font-bold mb-4 mt-8">Estoque Atual - Produtos para Casa</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
                            </tr>
                        </thead>
                        <tbody id="homeStockTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum produto para casa encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-bold mb-4 mt-8">Estoque Atual - Produtos Aliment√≠cios</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estoque</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
                            </tr>
                        </thead>
                        <tbody id="foodStockTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum produto aliment√≠cio encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Se√ß√£o: Registrar Pagamento -->
            <section id="section-payment" class="card hidden">
                <h2 class="text-2xl font-bold mb-6">Registrar Pagamento de Promiss√≥ria</h2>
                <form id="paymentForm">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="paymentInvoiceNumber" class="block text-sm font-medium text-gray-700 mb-1">N¬∫ NF/Recibo da Promiss√≥ria</label>
                            <input type="text" id="paymentInvoiceNumber" name="invoiceNumber" required class="w-full">
                        </div>
                        <div>
                            <label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-1">Valor Pago</label>
                            <input type="number" id="paymentAmount" name="amount" step="0.01" min="0" required class="w-full">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="paymentNewDueDate" class="block text-sm font-medium text-gray-700 mb-1">Nova Data de Vencimento (Opcional)</label>
                            <input type="date" id="paymentNewDueDate" name="newDueDate" class="w-full">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                    </div>
                </form>
            </section>

            <!-- Nova Se√ß√£o: Entrada de Nota Fiscal -->
            <section id="section-invoice-entry" class="card hidden">
                <h2 class="text-2xl font-bold mb-6">Entrada de Nota Fiscal</h2>
                <p class="text-sm text-gray-500 mb-4">Digite o n√∫mero da Nota Fiscal para preencher automaticamente os produtos para entrada no estoque. (Simula√ß√£o)</p>
                <form id="invoiceSearchForm" class="flex gap-4 mb-6">
                    <input type="text" id="invoiceNumber" name="invoiceNumber" placeholder="N¬∫ da Nota Fiscal" required class="flex-1">
                    <button type="submit" class="btn btn-primary">Buscar Nota</button>
                </form>
                <div id="invoiceDetails">
                    <div class="text-center text-gray-500 p-4" id="invoice-placeholder">
                        <span class="text-4xl">üßæ</span>
                        <p class="mt-2">Aguardando a busca de uma nota fiscal...</p>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Modal de Feedback (sucesso/erro) -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <p id="feedbackMessage" class="text-lg font-medium mb-4"></p>
            <button id="closeModalBtn" class="btn btn-primary">Fechar</button>
        </div>
    </div>

    <script>
        // Substitua esta URL pela URL do seu Google Apps Script
        const https:https://script.google.com/macros/s/AKfycbzSnbezZDoznyTRjMJzEV2TJnjLuUAsd5BRN0ghtA936t2L96QgzTHz1f8DM7HK70mM/exec'; 

        // Vari√°veis globais para armazenar dados
        let sales = [];
        let products = [];
        let clients = [];
        let cities = [];

        // Elementos do DOM
        const mainMenu = document.getElementById('main-menu');
        const contentSectionsContainer = document.getElementById('content-sections');
        const allContentSections = document.querySelectorAll('#content-sections section');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const actionButtons = document.querySelectorAll('.action-button');

        const addClientForm = document.getElementById('addClientForm');
        const addProductForm = document.getElementById('addProductForm');
        const removeProductForm = document.getElementById('removeProductForm'); // Novo formul√°rio de sa√≠da
        const paymentForm = document.getElementById('paymentForm');
        const invoiceSearchForm = document.getElementById('invoiceSearchForm');
        const invoiceDetailsDiv = document.getElementById('invoiceDetails');

        const allSalesTableBody = document.getElementById('allSalesTableBody');
        const upcomingDuesTableBody = document.getElementById('upcomingDuesTableBody');
        const homeStockTableBody = document.getElementById('homeStockTableBody');
        const foodStockTableBody = document.getElementById('foodStockTableBody');
        const clientsTableBody = document.getElementById('clientsTableBody');
        const upcomingClientsTableBody = document.getElementById('upcomingClientsTableBody'); // Nova tabela
        const clientFilterSelect = document.getElementById('clientFilterSelect');
        const cityFilterSelect = document.getElementById('cityFilterSelect');
        const clientCityFilterSelect = document.getElementById('clientCityFilterSelect');
        const clientBalanceFilterSelect = document.getElementById('clientBalanceFilterSelect'); // Novo filtro
        const clientPhoneInput = document.getElementById('clientPhone');
        const clientRGInput = document.getElementById('clientRG');
        const clientCPFInput = document.getElementById('clientCPF');
        const removeProductSelect = document.getElementById('removeProductSelect');

        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Configura as m√°scaras de entrada usando IMask
        IMask(clientPhoneInput, { mask: '(00) 00000-0000' });
        IMask(clientRGInput, { mask: '00.000.000-0' });
        IMask(clientCPFInput, { mask: '000.000.000-00' });

        // Simula√ß√£o de banco de dados de notas fiscais
        const dummyInvoices = {
            'NF-001': {
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD-123', description: 'Parafusos', quantity: 100, price: 0.5 },
                    { code: 'PROD-456', description: 'Tinta Branca 1L', quantity: 50, price: 25.00 }
                ]
            },
            'NF-002': {
                supplier: 'Fornecedor B',
                products: [
                    { code: 'PROD-456', description: 'Tinta Branca 1L', quantity: 20, price: 24.50 },
                    { code: 'PROD-789', description: 'Martelo', quantity: 10, price: 40.00 },
                    { code: 'PROD-101', description: 'Cabo de Vassoura', quantity: 25, price: 1.50 }
                ]
            },
            'NF-999': {
                supplier: 'Novo Fornecedor LTDA',
                products: [
                    { code: 'PROD-NOVO-1', description: 'Cadeira de Escrit√≥rio', quantity: 5, price: 350.00 },
                    { code: 'PROD-NOVO-2', description: 'Mesa de Reuni√£o', quantity: 2, price: 800.00 }
                ]
            }
        };

        // Fun√ß√£o para mostrar o modal de feedback
        function showFeedbackModal(message, isSuccess = true) {
            feedbackMessage.textContent = message;
            feedbackMessage.style.color = isSuccess ? '#10B981' : '#EF4444';
            feedbackModal.style.display = 'flex';
        }

        // Fun√ß√£o para fechar o modal
        closeModalBtn.addEventListener('click', () => {
            feedbackModal.style.display = 'none';
        });

        // Fun√ß√£o para carregar os dados do Google Sheets
        async function loadData() {
            try {
                // Mensagens de carregamento
                allSalesTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>';
                upcomingDuesTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>';
                homeStockTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>';
                foodStockTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>';
                clientsTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>';
                upcomingClientsTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando dados...</td></tr>';

                console.log('Fetching data from URL:', `${SCRIPT_URL}?type=get_all_data`);

                const response = await fetch(`${SCRIPT_URL}?type=get_all_data`);
                
                if (!response.ok) {
                    console.error('Network response was not ok:', response.status, response.statusText);
                    throw new Error(`Erro do servidor: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                sales = data.sales || [];
                products = data.products || [];
                clients = data.clients || [];
                
                // Extrai as cidades √∫nicas para os filtros
                cities = [...new Set(clients.map(client => client.Cidade))].sort();

                // Calcula o saldo total de cada cliente
                clients.forEach(client => {
                    const clientSales = sales.filter(sale => sale.Cliente === client.Nome);
                    const totalBalance = clientSales.reduce((sum, sale) => sum + parseFloat(sale['Saldo a Pagar']), 0);
                    client.balance = totalBalance;
                });

                // Renderiza as tabelas com os dados carregados
                renderSales();
                renderUpcomingDues();
                renderStock();
                renderClients();
                populateClientFilter();
                populateCityFilters();
                populateRemoveProductSelect();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                console.error('Detalhes do erro de fetch:', error.message, error);
                showFeedbackModal('Erro ao carregar os dados. Por favor, verifique a URL do Apps Script e sua conex√£o.', false);
            }
        }

        // Fun√ß√£o para popular o select de filtro de clientes
        function populateClientFilter() {
            clientFilterSelect.innerHTML = '<option value="">Todos os Clientes</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.ID;
                option.textContent = client.Nome;
                clientFilterSelect.appendChild(option);
            });
        }
        
        // Fun√ß√£o para popular os selects de filtro de cidades
        function populateCityFilters() {
            const cityOptions = '<option value="">Todas as Cidades</option>' + cities.map(city => `<option value="${city}">${city}</option>`).join('');
            cityFilterSelect.innerHTML = cityOptions;
            clientCityFilterSelect.innerHTML = cityOptions;
        }

        // Fun√ß√£o para popular o select de remo√ß√£o de produtos
        function populateRemoveProductSelect() {
            removeProductSelect.innerHTML = '<option value="">Selecione um produto</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                // Adiciona a descri√ß√£o e a quantidade em estoque para ajudar o usu√°rio
                option.textContent = `${product.Descri√ß√£o} (${product.Estoque} em estoque)`;
                option.value = product.C√≥digo;
                removeProductSelect.appendChild(option);
            });
        }

        // Fun√ß√µes de renderiza√ß√£o
        function renderClients() {
            const selectedCity = clientCityFilterSelect.value;
            const balanceFilter = clientBalanceFilterSelect.value;
            let filteredClients = clients;

            if (selectedCity) {
                filteredClients = clients.filter(client => client.Cidade === selectedCity);
            }
            if (balanceFilter === 'due') {
                filteredClients = filteredClients.filter(client => client.balance > 0);
            } else if (balanceFilter === 'paid') {
                filteredClients = filteredClients.filter(client => client.balance === 0);
            }
            
            clientsTableBody.innerHTML = '';
            if (filteredClients.length === 0) {
                clientsTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum cliente encontrado com os filtros selecionados.</td></tr>';
            } else {
                filteredClients.forEach(client => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-100');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.ID || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.Nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.Telefone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.Rua}, ${client.N√∫mero} ${client.Complemento ? `(${client.Complemento})` : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.Cidade}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${client.balance.toFixed(2).replace('.', ',')}</td>
                    `;
                    clientsTableBody.appendChild(row);
                });
            }

            // Renderiza a nova tabela de clientes com vencimentos pr√≥ximos
            const today = new Date();
            const thirtyDaysLater = new Date();
            thirtyDaysLater.setDate(today.getDate() + 30);
            
            // Encontra clientes com promiss√≥rias a vencer nos pr√≥ximos 30 dias
            const upcomingDuesClientIds = new Set();
            sales.forEach(sale => {
                const dueDate = new Date(sale['Data Vencimento']);
                const hasBalance = parseFloat(sale['Saldo a Pagar']) > 0;
                const isUpcoming = dueDate >= today && dueDate <= thirtyDaysLater;
                if (hasBalance && isUpcoming) {
                    const client = clients.find(c => c.Nome === sale.Cliente);
                    if (client) {
                        upcomingDuesClientIds.add(client.ID);
                    }
                }
            });

            const upcomingClients = clients.filter(client => upcomingDuesClientIds.has(client.ID));
            
            upcomingClientsTableBody.innerHTML = '';
            if (upcomingClients.length === 0) {
                upcomingClientsTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum cliente com vencimentos pr√≥ximos.</td></tr>';
            } else {
                upcomingClients.forEach(client => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-100');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.ID || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.Nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.Telefone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${client.balance.toFixed(2).replace('.', ',')}</td>
                    `;
                    upcomingClientsTableBody.appendChild(row);
                });
            }
        }
        
        function renderSales() {
            const selectedClientId = clientFilterSelect.value;
            const selectedCity = cityFilterSelect.value;
            let filteredSales = sales;

            if (selectedClientId) {
                const selectedClient = clients.find(c => c.ID == selectedClientId);
                if (selectedClient) {
                    filteredSales = filteredSales.filter(sale => sale.Cliente === selectedClient.Nome);
                } else {
                    filteredSales = [];
                }
            }
            if (selectedCity) {
                const clientsInCity = clients.filter(c => c.Cidade === selectedCity).map(c => c.Nome);
                filteredSales = filteredSales.filter(sale => clientsInCity.includes(sale.Cliente));
            }
            
            allSalesTableBody.innerHTML = '';
            if (filteredSales.length === 0) {
                allSalesTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhuma venda encontrada.</td></tr>';
                return;
            }
            filteredSales.forEach(sale => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale['N¬∫ NF/Recibo'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.Cliente}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale['Data Vencimento']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${parseFloat(sale['Valor Total']).toFixed(2).replace('.', ',')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${parseFloat(sale['Saldo a Pagar']).toFixed(2).replace('.', ',')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <!-- Bot√µes de a√ß√£o, se necess√°rio -->
                    </td>
                `;
                allSalesTableBody.appendChild(row);
            });
        }
        
        function renderUpcomingDues() {
            const today = new Date();
            const thirtyDaysLater = new Date();
            thirtyDaysLater.setDate(today.getDate() + 30);
            const upcomingDues = sales.filter(sale => {
                const dueDate = new Date(sale['Data Vencimento']);
                const hasBalance = parseFloat(sale['Saldo a Pagar']) > 0;
                const isUpcoming = dueDate >= today && dueDate <= thirtyDaysLater;
                return hasBalance && isUpcoming;
            });
            
            upcomingDuesTableBody.innerHTML = '';
            if (upcomingDues.length === 0) {
                upcomingDuesTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum vencimento pr√≥ximo.</td></tr>';
                return;
            }
            upcomingDues.forEach(sale => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale['N¬∫ NF/Recibo'] || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.Cliente}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale['Data Vencimento']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${parseFloat(sale['Saldo a Pagar']).toFixed(2).replace('.', ',')}</td>
                `;
                upcomingDuesTableBody.appendChild(row);
            });
        }

        function renderStock() {
            // Filtra os produtos por categoria
            const homeProducts = products.filter(p => p.Categoria === 'Para Casa');
            const foodProducts = products.filter(p => p.Categoria === 'Aliment√≠cio');
            
            // Renderiza a tabela de produtos para casa
            homeStockTableBody.innerHTML = '';
            if (homeProducts.length === 0) {
                homeStockTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum produto para casa encontrado.</td></tr>';
            } else {
                homeProducts.forEach(product => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-100');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.C√≥digo || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.Descri√ß√£o}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.Estoque}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${parseFloat(product.Pre√ßo).toFixed(2).replace('.', ',')}</td>
                    `;
                    homeStockTableBody.appendChild(row);
                });
            }

            // Renderiza a tabela de produtos aliment√≠cios
            foodStockTableBody.innerHTML = '';
            if (foodProducts.length === 0) {
                foodStockTableBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum produto aliment√≠cio encontrado.</td></tr>';
            } else {
                foodProducts.forEach(product => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-100');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.C√≥digo || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.Descri√ß√£o}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.Estoque}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${parseFloat(product.Pre√ßo).toFixed(2).replace('.', ',')}</td>
                    `;
                    foodStockTableBody.appendChild(row);
                });
            }
        }
        
        // Fun√ß√£o para adicionar/atualizar um produto no estoque (localmente)
        async function addSingleProduct(productData) {
            // Verifica se o produto j√° existe no array local de produtos
            const existingProductIndex = products.findIndex(p => p.C√≥digo === productData.code);

            if (existingProductIndex !== -1) {
                // Se o produto j√° existe, atualiza o estoque
                products[existingProductIndex].Estoque = parseInt(products[existingProductIndex].Estoque) + parseInt(productData.quantity);
                showFeedbackModal(`Estoque do produto ${products[existingProductIndex].Descri√ß√£o} atualizado!`);
            } else {
                // Se n√£o existe, cria um novo produto
                const newProduct = {
                    C√≥digo: productData.code,
                    Descri√ß√£o: productData.description,
                    Estoque: productData.quantity,
                    Pre√ßo: productData.price,
                    // Por padr√£o, produtos da NF simulada s√£o de "Para Casa"
                    Categoria: 'Para Casa' 
                };
                products.push(newProduct);
                showFeedbackModal(`Produto ${productData.description} adicionado ao estoque!`);
            }
            renderStock();
        }

        // Fun√ß√µes de evento
        addClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const clientData = {
                type: 'add_client',
                data: {
                    name: formData.get('clientName'),
                    phone: formData.get('clientPhone'),
                    rg: formData.get('clientRG'),
                    cpf: formData.get('clientCPF'),
                    street: formData.get('clientStreet'),
                    number: formData.get('clientNumber'),
                    complement: formData.get('clientComplement'),
                    neighborhood: formData.get('clientNeighborhood'),
                    city: formData.get('clientCity')
                }
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(clientData),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showFeedbackModal('Cliente cadastrado com sucesso! Recarregando dados...');
                    e.target.reset();
                    loadData();
                } else {
                    showFeedbackModal('Erro ao cadastrar cliente: ' + result.message, false);
                }
            } catch (error) {
                console.error('Erro de conex√£o:', error);
                showFeedbackModal('Erro de conex√£o. Verifique sua internet.', false);
            }
        });

        // Event listener para o novo formul√°rio de produtos
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productData = {
                type: 'add_product',
                data: {
                    code: formData.get('productCode') || '', // C√≥digo agora √© opcional
                    description: formData.get('productDescription'),
                    stock: parseInt(formData.get('productStock')),
                    price: parseFloat(formData.get('productPrice')),
                    category: formData.get('productCategory')
                }
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(productData),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showFeedbackModal('Produto adicionado com sucesso! Recarregando dados...');
                    e.target.reset();
                    loadData();
                } else {
                    showFeedbackModal('Erro ao adicionar produto: ' + result.message, false);
                }
            } catch (error) {
                console.error('Erro de conex√£o:', error);
                showFeedbackModal('Erro de conex√£o. Verifique sua internet.', false);
            }
        });

        // Event listener para o formul√°rio de remo√ß√£o de produtos
        removeProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productCode = formData.get('productCode');
            const quantity = parseInt(formData.get('quantity'));

            if (!productCode || isNaN(quantity) || quantity <= 0) {
                showFeedbackModal('Por favor, selecione um produto e digite uma quantidade v√°lida.', false);
                return;
            }

            // Verifica se a quantidade em estoque √© suficiente
            const productInStock = products.find(p => p.C√≥digo === productCode);
            if (!productInStock || productInStock.Estoque < quantity) {
                showFeedbackModal('N√£o h√° estoque suficiente para esta quantidade.', false);
                return;
            }

            const removalData = {
                type: 'remove_stock',
                data: {
                    code: productCode,
                    quantity: quantity
                }
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(removalData),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showFeedbackModal('Sa√≠da de estoque registrada com sucesso! Recarregando dados...');
                    e.target.reset();
                    loadData();
                } else {
                    showFeedbackModal('Erro ao registrar a sa√≠da de estoque: ' + result.message, false);
                }
            } catch (error) {
                console.error('Erro de conex√£o:', error);
                showFeedbackModal('Erro de conex√£o. Verifique sua internet.', false);
            }
        });

        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const paymentData = {
                type: 'add_payment',
                invoiceNumber: formData.get('invoiceNumber'),
                amount: parseFloat(formData.get('amount')),
                newDueDate: formData.get('newDueDate') || null
            };

            if (paymentData.amount <= 0 || !paymentData.invoiceNumber) {
                showFeedbackModal('Por favor, preencha o n√∫mero da promiss√≥ria e o valor.', false);
                return;
            }

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(paymentData),
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showFeedbackModal('Pagamento registrado com sucesso! Recarregando dados...');
                    e.target.reset();
                    loadData();
                } else {
                    showFeedbackModal('Erro ao registrar pagamento: ' + result.message, false);
                }
            } catch (error) {
                console.error('Erro de conex√£o:', error);
                showFeedbackModal('Erro de conex√£o. Verifique sua internet.', false);
            }
        });

        // Event listener para o novo formul√°rio de busca de nota fiscal
        invoiceSearchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const invoiceNumber = document.getElementById('invoiceNumber').value.toUpperCase().trim();
            const invoiceData = dummyInvoices[invoiceNumber];

            if (invoiceData) {
                renderInvoiceDetails(invoiceNumber, invoiceData);
                showFeedbackModal('Nota Fiscal encontrada!');
            } else {
                invoiceDetailsDiv.innerHTML = `
                    <div class="text-center text-gray-500 p-4">
                        <span class="text-4xl">üòî</span>
                        <p class="mt-2">Nota fiscal n√£o encontrada. Tente "NF-001", "NF-002" ou "NF-999".</p>
                    </div>`;
                showFeedbackModal('Nota Fiscal n√£o encontrada.', false);
            }
        });

        // Fun√ß√£o para renderizar os detalhes da nota fiscal simulada
        function renderInvoiceDetails(invoiceNumber, data) {
            invoiceDetailsDiv.innerHTML = `
                <div class="mb-6">
                    <p class="text-lg font-semibold">Fornecedor: <span class="text-gray-600">${data.supplier}</span></p>
                    <p class="text-lg font-semibold">Nota Fiscal: <span class="text-gray-600">${invoiceNumber}</span></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descri√ß√£o</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo Unit√°rio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceProductsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            `;
            const invoiceProductsTableBody = document.getElementById('invoiceProductsTableBody');
            data.products.forEach(product => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.code}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${parseFloat(product.price).toFixed(2).replace('.', ',')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="add-to-stock-btn btn btn-primary text-xs" data-product='${JSON.stringify(product)}'>Adicionar ao Estoque</button>
                    </td>
                `;
                invoiceProductsTableBody.appendChild(row);
            });
            // Adiciona event listener para os bot√µes rec√©m-criados
            document.querySelectorAll('.add-to-stock-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const product = JSON.parse(e.target.dataset.product);
                    addSingleProduct(product);
                });
            });
        }


        // Eventos para atualiza√ß√£o da tela
        clientFilterSelect.addEventListener('change', renderSales);
        cityFilterSelect.addEventListener('change', renderSales);
        clientCityFilterSelect.addEventListener('change', renderClients);
        clientBalanceFilterSelect.addEventListener('change', renderClients); // Novo evento para o filtro de saldo

        // Fun√ß√£o para alternar entre o menu e as se√ß√µes de conte√∫do
        function showSection(targetSectionId) {
            mainMenu.classList.add('hidden');
            contentSectionsContainer.classList.remove('hidden');
            
            allContentSections.forEach(section => {
                section.classList.add('hidden');
            });
            
            const targetSection = document.getElementById(targetSectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
        }

        // Event listeners para os bot√µes do menu
        actionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const target = e.currentTarget.dataset.target;
                showSection(target);
            });
        });

        // Event listener para o bot√£o de voltar ao menu
        backToMenuBtn.addEventListener('click', () => {
            mainMenu.classList.remove('hidden');
            contentSectionsContainer.classList.add('hidden');
            // Reseta o estado da se√ß√£o de nota fiscal
            document.getElementById('invoiceNumber').value = '';
            invoiceDetailsDiv.innerHTML = `
                <div class="text-center text-gray-500 p-4" id="invoice-placeholder">
                    <span class="text-4xl">üßæ</span>
                    <p class="mt-2">Aguardando a busca de uma nota fiscal...</p>
                </div>`;
        });
        
        // Dispara a carga de dados ao carregar a p√°gina
        loadData();

        // Configura uma atualiza√ß√£o autom√°tica a cada 30 segundos
        setInterval(loadData, 30000);
    </script>
</body>
</html>
