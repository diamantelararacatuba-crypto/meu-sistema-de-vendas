<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira e Estoque</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/imask"></script>
    <style>
        /* Estilos CSS gerais */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        h1, h2 {
            font-weight: 700;
            color: #111827;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .hidden {
            display: none !important;
        }
        /* Ajuste para telas pequenas */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Container principal -->
    <div class="container bg-white rounded-3xl shadow-xl p-8 max-w-4xl w-full">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Sistema de Gest√£o</h1>
            <p class="text-gray-500 mt-2">Escolha uma a√ß√£o para come√ßar.</p>
        </header>

        <!-- Main Menu - Vis√≠vel por padr√£o -->
        <div id="main-menu" class="space-y-6">
            <h2 class="text-xl sm:text-2xl font-bold text-center text-gray-800 mb-4">Menu Principal</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Bot√£o: Cadastrar Cliente -->
                <button data-target="register-client" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-green-50 focus:outline-none focus:ring-4 focus:ring-green-500/50">
                    <span class="text-5xl mb-2">üßë‚Äçüíª</span>
                    <span class="text-lg font-semibold text-gray-800">Cadastrar Cliente</span>
                </button>
                <!-- Bot√£o: Ver Clientes -->
                <button data-target="view-clients" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-blue-50 focus:outline-none focus:ring-4 focus:ring-blue-500/50">
                    <span class="text-5xl mb-2">üë•</span>
                    <span class="text-lg font-semibold text-gray-800">Ver Clientes</span>
                </button>
                <!-- Bot√£o: Vendas e Promiss√≥rias -->
                <button data-target="promissory-sales" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-purple-50 focus:outline-none focus:ring-4 focus:ring-purple-500/50">
                    <span class="text-5xl mb-2">üí∏</span>
                    <span class="text-lg font-semibold text-gray-800">Vendas e Promiss√≥rias</span>
                </button>
                <!-- Bot√£o: Pr√≥ximos Vencimentos -->
                <button data-target="upcoming-due-dates" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-red-50 focus:outline-none focus:ring-4 focus:ring-red-500/50">
                    <span class="text-5xl mb-2">üìÖ</span>
                    <span class="text-lg font-semibold text-gray-800">Pr√≥ximos Vencimentos</span>
                </button>
                <!-- Bot√£o: Controle de Estoque -->
                <button data-target="stock-control" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-orange-50 focus:outline-none focus:ring-4 focus:ring-orange-500/50">
                    <span class="text-5xl mb-2">üì¶</span>
                    <span class="text-lg font-semibold text-gray-800">Controle de Estoque</span>
                </button>
                <!-- Bot√£o: Registrar Pagamento -->
                <button data-target="register-payment" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-500/50">
                    <span class="text-5xl mb-2">üíµ</span>
                    <span class="text-lg font-semibold text-gray-800">Registrar Pagamento</span>
                </button>
                 <!-- Bot√£o: Entrada de Nota Fiscal -->
                 <button data-target="invoice-entry" class="action-button card flex flex-col items-center justify-center p-6 text-center transition-all duration-300 transform hover:scale-105 hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-500/50">
                    <span class="text-5xl mb-2">üßæ</span>
                    <span class="text-lg font-semibold text-gray-800">Entrada de Nota Fiscal</span>
                </button>
            </div>
        </div>

        <!-- Content Sections Container - Inicialmente escondido -->
        <div id="content-sections-container" class="hidden">
            <!-- Bot√£o de Voltar -->
            <button id="back-to-menu-btn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-full transition-colors duration-300 hover:bg-gray-300 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Voltar
            </button>
            
            <!-- Todas as se√ß√µes de conte√∫do - inicialmente escondidas -->
            
            <!-- Se√ß√£o: Cadastrar Cliente -->
            <div id="register-client" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Cadastrar Cliente</h2>
                <div class="card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="client-name" placeholder="Nome" class="p-3 border rounded-lg">
                        <input type="text" id="client-phone" placeholder="Telefone" class="p-3 border rounded-lg">
                        <input type="text" id="client-rg" placeholder="RG" class="p-3 border rounded-lg">
                        <input type="text" id="client-cpf" placeholder="CPF" class="p-3 border rounded-lg">
                        <input type="text" id="client-street" placeholder="Rua" class="p-3 border rounded-lg">
                        <input type="text" id="client-number" placeholder="N√∫mero" class="p-3 border rounded-lg">
                        <input type="text" id="client-complement" placeholder="Complemento" class="p-3 border rounded-lg">
                        <input type="text" id="client-neighborhood" placeholder="Bairro" class="p-3 border rounded-lg">
                        <input type="text" id="client-city" placeholder="Cidade" class="p-3 border rounded-lg">
                    </div>
                    <button id="save-client-btn" class="bg-blue-600 text-white p-3 rounded-lg mt-4 w-full hover:bg-blue-700 transition-colors">Salvar Cliente</button>
                    <div id="client-status-message" class="mt-4 text-center"></div>
                </div>
            </div>

            <!-- Se√ß√£o: Ver Clientes -->
            <div id="view-clients" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Ver Clientes</h2>
                <div class="card p-6">
                    <div class="mb-4">
                        <label for="city-filter" class="block text-sm font-medium text-gray-700">Filtrar por Cidade:</label>
                        <select id="city-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="all">Todas as Cidades</option>
                        </select>
                    </div>
                    <div id="clients-list" class="overflow-x-auto">
                        <!-- Lista de clientes ser√° renderizada aqui -->
                    </div>
                    <div id="no-clients-message" class="text-center text-gray-500 p-4 mt-4 hidden">Nenhum cliente encontrado.</div>
                </div>
            </div>

            <!-- Se√ß√£o: Vendas e Promiss√≥rias -->
            <div id="promissory-sales" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Vendas e Promiss√≥rias</h2>
                <div class="card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="sale-client-id" placeholder="ID do Cliente" class="p-3 border rounded-lg">
                        <input type="text" id="sale-client-name" placeholder="Nome do Cliente (Autom√°tico)" class="p-3 border rounded-lg bg-gray-100" disabled>
                        <input type="date" id="sale-date" placeholder="Data da Venda" class="p-3 border rounded-lg">
                        <input type="date" id="due-date" placeholder="Data de Vencimento" class="p-3 border rounded-lg">
                        <input type="number" id="total-value" placeholder="Valor Total da Nota Promiss√≥ria" class="p-3 border rounded-lg">
                        <input type="number" id="initial-payment" placeholder="Valor de Entrada (opcional)" class="p-3 border rounded-lg">
                    </div>
                    <button id="add-sale-btn" class="bg-purple-600 text-white p-3 rounded-lg mt-4 w-full hover:bg-purple-700 transition-colors">Adicionar Venda</button>
                    <div id="sale-status-message" class="mt-4 text-center"></div>
                </div>
            </div>

            <!-- Se√ß√£o: Pr√≥ximos Vencimentos -->
            <div id="upcoming-due-dates" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Pr√≥ximos Vencimentos</h2>
                <div class="card p-6">
                    <div id="upcoming-list" class="overflow-x-auto">
                        <!-- Lista de vencimentos ser√° renderizada aqui -->
                    </div>
                    <div id="no-upcoming-message" class="text-center text-gray-500 p-4 mt-4 hidden">Nenhum vencimento pr√≥ximo.</div>
                </div>
            </div>

            <!-- Se√ß√£o: Controle de Estoque -->
            <div id="stock-control" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Controle de Estoque</h2>
                <div class="card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="product-code" placeholder="C√≥digo (gerado auto se vazio)" class="p-3 border rounded-lg">
                        <input type="text" id="product-description" placeholder="Descri√ß√£o do Produto" class="p-3 border rounded-lg">
                        <input type="number" id="stock-quantity" placeholder="Quantidade em Estoque" class="p-3 border rounded-lg">
                        <input type="number" id="product-price" placeholder="Pre√ßo" class="p-3 border rounded-lg">
                        <select id="product-category" class="p-3 border rounded-lg">
                            <option value="casa">Produtos de Casa</option>
                            <option value="alimenticio">Produtos Aliment√≠cios</option>
                        </select>
                    </div>
                    <button id="add-product-btn" class="bg-orange-600 text-white p-3 rounded-lg mt-4 w-full hover:bg-orange-700 transition-colors">Adicionar Produto</button>
                    <div id="stock-status-message" class="mt-4 text-center"></div>
                </div>
            </div>

            <!-- Se√ß√£o: Registrar Pagamento -->
            <div id="register-payment" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Registrar Pagamento</h2>
                <div class="card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="payment-client-id" placeholder="ID do Cliente" class="p-3 border rounded-lg">
                        <input type="text" id="payment-client-name" placeholder="Nome do Cliente (Autom√°tico)" class="p-3 border rounded-lg bg-gray-100" disabled>
                        <input type="text" id="payment-sale-id" placeholder="ID da Venda" class="p-3 border rounded-lg">
                        <input type="text" id="payment-sale-details" placeholder="Detalhes da Venda (Autom√°tico)" class="p-3 border rounded-lg bg-gray-100" disabled>
                        <input type="date" id="payment-date" placeholder="Data de Pagamento" class="p-3 border rounded-lg">
                        <input type="number" id="amount-paid" placeholder="Valor Pago" class="p-3 border rounded-lg">
                    </div>
                    <div id="payment-balance-info" class="mt-4 text-gray-600"></div>
                    <button id="add-payment-btn" class="bg-gray-600 text-white p-3 rounded-lg mt-4 w-full hover:bg-gray-700 transition-colors">Registrar Pagamento</button>
                    <div id="payment-status-message" class="mt-4 text-center"></div>
                </div>
            </div>
            
             <!-- Se√ß√£o: Entrada de Nota Fiscal -->
            <div id="invoice-entry" class="content-section hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Entrada de Nota Fiscal</h2>
                <div class="card p-6">
                    <div class="flex items-center space-x-4 mb-4">
                        <input type="text" id="invoiceNumber" placeholder="N√∫mero da Nota Fiscal" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-300">
                    </div>
                    <div id="invoiceDetailsDiv" class="mt-4">
                        <div class="text-center text-gray-500 p-4" id="invoice-placeholder">
                            <span class="text-4xl">üßæ</span>
                            <p class="mt-2">Aguardando a busca de uma nota fiscal...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-COaCEKwCbL521gv3PIQXbj3-HWSYLMRyIoGewaiPuErxXhSRfsAn58yjOaE3_Pr_/exec';

        // Vari√°veis de elementos do DOM
        const mainMenu = document.getElementById('main-menu');
        const contentSectionsContainer = document.getElementById('content-sections-container');
        const actionButtons = document.querySelectorAll('.action-button');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const invoiceDetailsDiv = document.getElementById('invoiceDetailsDiv');
        
        let appData = {
            clientes: [],
            produtos: [],
            vendas: []
        };

        // Fun√ß√£o gen√©rica para comunica√ß√£o com o Google Apps Script
        async function fetchApi(action, payload) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action, ...payload })
                });

                if (!response.ok) {
                    throw new Error(`Erro na resposta da rede: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Erro ao comunicar com a API:', error);
                throw error;
            }
        }

        async function loadData() {
            try {
                const result = await fetchApi('loadData');
                appData = result;
                console.log('Dados carregados com sucesso:', appData);
            } catch (error) {
                console.error('Falha ao carregar dados do servidor.');
            }
        }

        // Fun√ß√£o para mostrar uma se√ß√£o e esconder as outras
        function showSection(targetSectionId) {
            const allContentSections = document.querySelectorAll('.content-section');
            allContentSections.forEach(section => {
                section.classList.add('hidden');
            });
            const targetSection = document.getElementById(targetSectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
        }

        // --- L√≥gica das Novas Se√ß√µes ---
        
        // Se√ß√£o: Cadastrar Cliente
        function setupRegisterClientSection() {
            const saveClientBtn = document.getElementById('save-client-btn');
            const statusMessage = document.getElementById('client-status-message');
            saveClientBtn.addEventListener('click', async () => {
                statusMessage.textContent = 'Salvando cliente...';
                statusMessage.className = 'mt-4 text-center text-gray-500';
                const name = document.getElementById('client-name').value;
                const phone = document.getElementById('client-phone').value;
                const rg = document.getElementById('client-rg').value;
                const cpf = document.getElementById('client-cpf').value;
                const street = document.getElementById('client-street').value;
                const number = document.getElementById('client-number').value;
                const complement = document.getElementById('client-complement').value;
                const neighborhood = document.getElementById('client-neighborhood').value;
                const city = document.getElementById('client-city').value;

                if (!name || !phone) {
                    statusMessage.textContent = 'Nome e Telefone s√£o obrigat√≥rios.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                    return;
                }

                const newClient = {
                    nome: name,
                    telefone: phone,
                    rg: rg,
                    cpf: cpf,
                    endereco: {
                        rua: street,
                        numero: number,
                        complemento: complement,
                        bairro: neighborhood,
                        cidade: city
                    }
                };
                
                try {
                    const result = await fetchApi('addClient', { client: newClient });
                    if (result.success) {
                        statusMessage.textContent = `Cliente "${name}" cadastrado com sucesso! ID: ${result.newId}`;
                        statusMessage.className = 'mt-4 text-center text-green-500';
                        // Limpa os campos
                        document.getElementById('register-client').querySelectorAll('input').forEach(input => input.value = '');
                    } else {
                        statusMessage.textContent = 'Erro ao cadastrar cliente: ' + result.error;
                        statusMessage.className = 'mt-4 text-center text-red-500';
                    }
                } catch (error) {
                    statusMessage.textContent = 'Erro de comunica√ß√£o com o servidor.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                }
            });
        }

        // Se√ß√£o: Ver Clientes
        function setupViewClientsSection() {
            const clientsListDiv = document.getElementById('clients-list');
            const cityFilterSelect = document.getElementById('city-filter');
            const noClientsMessage = document.getElementById('no-clients-message');

            async function renderClients(filterCity) {
                clientsListDiv.innerHTML = '<div class="text-center text-gray-500 p-4">Carregando clientes...</div>';

                try {
                    const clients = await fetchApi('getClients');
                    const cities = new Set(clients.map(c => c.endereco.cidade));
                    
                    cityFilterSelect.innerHTML = `<option value="all">Todas as Cidades</option>`;
                    cities.forEach(city => {
                        if (city) {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            cityFilterSelect.appendChild(option);
                        }
                    });

                    if (filterCity !== 'all') {
                        cityFilterSelect.value = filterCity;
                    }

                    let filteredClients = clients;
                    if (filterCity !== 'all') {
                        filteredClients = clients.filter(c => c.endereco.cidade === filterCity);
                    }

                    if (filteredClients.length === 0) {
                        clientsListDiv.innerHTML = '';
                        noClientsMessage.classList.remove('hidden');
                        return;
                    }

                    noClientsMessage.classList.add('hidden');
                    const tableHtml = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Endere√ßo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cidade</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredClients.map(client => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.nome}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.telefone}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.endereco.rua}, ${client.endereco.numero} - ${client.endereco.bairro}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.endereco.cidade}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    clientsListDiv.innerHTML = tableHtml;
                } catch (error) {
                    clientsListDiv.innerHTML = '<div class="text-center text-red-500 p-4">Erro ao carregar os clientes.</div>';
                }
            }

            cityFilterSelect.addEventListener('change', (e) => {
                renderClients(e.target.value);
            });

            // Adiciona o listener para o carregamento da se√ß√£o
            document.getElementById('view-clients').addEventListener('section-visible', () => renderClients('all'));
        }

        // Se√ß√£o: Vendas e Promiss√≥rias
        function setupPromissorySalesSection() {
            const saleClientIdInput = document.getElementById('sale-client-id');
            const saleClientNameInput = document.getElementById('sale-client-name');
            const addSaleBtn = document.getElementById('add-sale-btn');
            const statusMessage = document.getElementById('sale-status-message');

            let searchTimeout;

            // Busca o nome do cliente ao digitar o ID
            saleClientIdInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const clientId = saleClientIdInput.value.trim();
                saleClientNameInput.value = 'Buscando...';

                if (clientId) {
                    searchTimeout = setTimeout(async () => {
                        try {
                            const client = await fetchApi('getClientById', { clientId });
                            if (client && client.nome) {
                                saleClientNameInput.value = client.nome;
                            } else {
                                saleClientNameInput.value = 'Cliente n√£o encontrado.';
                            }
                        } catch (error) {
                            saleClientNameInput.value = 'Erro na busca.';
                        }
                    }, 500); // Debounce de 500ms
                } else {
                    saleClientNameInput.value = '';
                }
            });

            // Lidar com o envio do formul√°rio
            addSaleBtn.addEventListener('click', async () => {
                const clientId = saleClientIdInput.value.trim();
                const saleDate = document.getElementById('sale-date').value;
                const dueDate = document.getElementById('due-date').value;
                const totalValue = document.getElementById('total-value').value;
                const initialPayment = document.getElementById('initial-payment').value || 0;

                if (!clientId || !saleDate || !dueDate || !totalValue) {
                    statusMessage.textContent = 'Por favor, preencha todos os campos obrigat√≥rios.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                    return;
                }
                
                statusMessage.textContent = 'Adicionando venda...';
                statusMessage.className = 'mt-4 text-center text-gray-500';

                const newSale = {
                    clientId,
                    saleDate,
                    dueDate,
                    totalValue: parseFloat(totalValue),
                    initialPayment: parseFloat(initialPayment)
                };

                try {
                    const result = await fetchApi('addSale', { sale: newSale });
                    if (result.success) {
                        statusMessage.textContent = 'Venda e promiss√≥ria adicionadas com sucesso!';
                        statusMessage.className = 'mt-4 text-center text-green-500';
                        // Limpa os campos
                        document.getElementById('promissory-sales').querySelectorAll('input').forEach(input => input.value = '');
                        saleClientNameInput.value = ''; // Limpa o nome tamb√©m
                    } else {
                        statusMessage.textContent = 'Erro ao adicionar venda: ' + result.error;
                        statusMessage.className = 'mt-4 text-center text-red-500';
                    }
                } catch (error) {
                    statusMessage.textContent = 'Erro de comunica√ß√£o com o servidor.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                }
            });
        }

        // Se√ß√£o: Pr√≥ximos Vencimentos
        function setupUpcomingDueDatesSection() {
            const upcomingListDiv = document.getElementById('upcoming-list');
            const noUpcomingMessage = document.getElementById('no-upcoming-message');
            
            async function renderUpcoming() {
                upcomingListDiv.innerHTML = '<div class="text-center text-gray-500 p-4">Carregando vencimentos...</div>';

                try {
                    const upcoming = await fetchApi('getUpcomingDueDates');
                    if (upcoming.length === 0) {
                        upcomingListDiv.innerHTML = '';
                        noUpcomingMessage.classList.remove('hidden');
                        return;
                    }

                    noUpcomingMessage.classList.add('hidden');
                    const tableHtml = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Venda</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Pendente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${upcoming.map(item => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.saleId}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.clientName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${item.pendingValue.toFixed(2)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.dueDate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    upcomingListDiv.innerHTML = tableHtml;
                } catch (error) {
                    upcomingListDiv.innerHTML = '<div class="text-center text-red-500 p-4">Erro ao carregar os vencimentos.</div>';
                }
            }
            
            // Adiciona o listener para o carregamento da se√ß√£o
            document.getElementById('upcoming-due-dates').addEventListener('section-visible', renderUpcoming);
        }

        // Se√ß√£o: Controle de Estoque
        function setupStockControlSection() {
            const addProductBtn = document.getElementById('add-product-btn');
            const statusMessage = document.getElementById('stock-status-message');

            addProductBtn.addEventListener('click', async () => {
                const productCode = document.getElementById('product-code').value.trim();
                const productDescription = document.getElementById('product-description').value.trim();
                const stockQuantity = document.getElementById('stock-quantity').value;
                const productPrice = document.getElementById('product-price').value;
                const productCategory = document.getElementById('product-category').value;

                if (!productDescription || !stockQuantity || !productPrice) {
                    statusMessage.textContent = 'Por favor, preencha todos os campos obrigat√≥rios.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                    return;
                }
                
                statusMessage.textContent = 'Adicionando produto...';
                statusMessage.className = 'mt-4 text-center text-gray-500';

                const newProduct = {
                    codigo: productCode,
                    descricao: productDescription,
                    quantidade: parseInt(stockQuantity),
                    preco: parseFloat(productPrice),
                    categoria: productCategory
                };

                try {
                    const result = await fetchApi('addProduct', { product: newProduct });
                    if (result.success) {
                        statusMessage.textContent = `Produto "${productDescription}" adicionado com sucesso!`;
                        statusMessage.className = 'mt-4 text-center text-green-500';
                        // Limpa os campos
                        document.getElementById('stock-control').querySelectorAll('input').forEach(input => input.value = '');
                        document.getElementById('product-category').value = 'casa';
                    } else {
                        statusMessage.textContent = 'Erro ao adicionar produto: ' + result.error;
                        statusMessage.className = 'mt-4 text-center text-red-500';
                    }
                } catch (error) {
                    statusMessage.textContent = 'Erro de comunica√ß√£o com o servidor.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                }
            });
        }
        
        // Se√ß√£o: Registrar Pagamento
        function setupRegisterPaymentSection() {
            const paymentClientIdInput = document.getElementById('payment-client-id');
            const paymentClientNameInput = document.getElementById('payment-client-name');
            const paymentSaleIdInput = document.getElementById('payment-sale-id');
            const paymentSaleDetailsInput = document.getElementById('payment-sale-details');
            const addPaymentBtn = document.getElementById('add-payment-btn');
            const statusMessage = document.getElementById('payment-status-message');
            const balanceInfoDiv = document.getElementById('payment-balance-info');
            let clientSearchTimeout, saleSearchTimeout;

            // Busca nome do cliente ao digitar ID
            paymentClientIdInput.addEventListener('input', () => {
                clearTimeout(clientSearchTimeout);
                const clientId = paymentClientIdInput.value.trim();
                paymentClientNameInput.value = '';
                if (clientId) {
                    clientSearchTimeout = setTimeout(async () => {
                        try {
                            const client = await fetchApi('getClientById', { clientId });
                            if (client && client.nome) {
                                paymentClientNameInput.value = client.nome;
                            } else {
                                paymentClientNameInput.value = 'Cliente n√£o encontrado.';
                            }
                        } catch (error) {
                            paymentClientNameInput.value = 'Erro na busca.';
                        }
                    }, 500);
                }
            });

            // Busca detalhes da venda ao digitar ID da venda
            paymentSaleIdInput.addEventListener('input', () => {
                clearTimeout(saleSearchTimeout);
                const saleId = paymentSaleIdInput.value.trim();
                paymentSaleDetailsInput.value = '';
                balanceInfoDiv.textContent = '';
                if (saleId) {
                    saleSearchTimeout = setTimeout(async () => {
                        try {
                            const sale = await fetchApi('getSaleById', { saleId });
                            if (sale) {
                                paymentSaleDetailsInput.value = `Venda: ${sale.totalValue} | Pago: ${sale.paidAmount} | Vencimento: ${sale.dueDate}`;
                                balanceInfoDiv.textContent = `Saldo Devedor: R$ ${(sale.totalValue - sale.paidAmount).toFixed(2)}`;
                            } else {
                                paymentSaleDetailsInput.value = 'Venda n√£o encontrada.';
                            }
                        } catch (error) {
                            paymentSaleDetailsInput.value = 'Erro na busca.';
                        }
                    }, 500);
                }
            });

            addPaymentBtn.addEventListener('click', async () => {
                const clientId = paymentClientIdInput.value.trim();
                const saleId = paymentSaleIdInput.value.trim();
                const paymentDate = document.getElementById('payment-date').value;
                const amountPaid = document.getElementById('amount-paid').value;

                if (!clientId || !saleId || !paymentDate || !amountPaid) {
                    statusMessage.textContent = 'Por favor, preencha todos os campos obrigat√≥rios.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                    return;
                }
                
                statusMessage.textContent = 'Registrando pagamento...';
                statusMessage.className = 'mt-4 text-center text-gray-500';

                const paymentData = {
                    clientId,
                    saleId,
                    paymentDate,
                    amountPaid: parseFloat(amountPaid)
                };

                try {
                    const result = await fetchApi('addPayment', { payment: paymentData });
                    if (result.success) {
                        statusMessage.textContent = 'Pagamento registrado com sucesso!';
                        statusMessage.className = 'mt-4 text-center text-green-500';
                        // Limpa os campos
                        document.getElementById('register-payment').querySelectorAll('input').forEach(input => input.value = '');
                        paymentClientNameInput.value = '';
                        paymentSaleDetailsInput.value = '';
                        balanceInfoDiv.textContent = '';
                    } else {
                        statusMessage.textContent = 'Erro ao registrar pagamento: ' + result.error;
                        statusMessage.className = 'mt-4 text-center text-red-500';
                    }
                } catch (error) {
                    statusMessage.textContent = 'Erro de comunica√ß√£o com o servidor.';
                    statusMessage.className = 'mt-4 text-center text-red-500';
                }
            });
        }
        
        // Se√ß√£o: Entrada de Nota Fiscal
        function setupInvoiceEntrySection() {
            const invoiceNumberInput = document.getElementById('invoiceNumber');
            const invoiceDetailsDiv = document.getElementById('invoiceDetailsDiv');
            let searchTimeout;

            invoiceNumberInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const invoiceNumber = invoiceNumberInput.value.trim();
                invoiceDetailsDiv.innerHTML = '<div class="text-center text-gray-500 p-4">Buscando nota fiscal...</div>';

                if (invoiceNumber) {
                    searchTimeout = setTimeout(async () => {
                        try {
                            const invoice = await fetchApi('getInvoiceByNumber', { invoiceNumber });
                            if (invoice) {
                                invoiceDetailsDiv.innerHTML = `
                                    <div class="space-y-2">
                                        <p><span class="font-bold">Cliente:</span> ${invoice.clientName}</p>
                                        <p><span class="font-bold">Data de Emiss√£o:</span> ${invoice.issueDate}</p>
                                        <p><span class="font-bold">Valor Total:</span> R$ ${invoice.totalValue.toFixed(2)}</p>
                                        <p><span class="font-bold">Status:</span> <span class="text-green-600 font-semibold">Paga</span></p>
                                    </div>
                                `;
                            } else {
                                invoiceDetailsDiv.innerHTML = `
                                    <div class="text-center text-gray-500 p-4">
                                        <span class="text-4xl">‚ùå</span>
                                        <p class="mt-2">Nota fiscal n√£o encontrada.</p>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            invoiceDetailsDiv.innerHTML = `
                                <div class="text-center text-red-500 p-4">
                                    <span class="text-4xl">‚ö†Ô∏è</span>
                                    <p class="mt-2">Erro ao buscar a nota fiscal.</p>
                                </div>
                            `;
                            console.error('Erro:', error);
                        }
                    }, 500);
                } else {
                    invoiceDetailsDiv.innerHTML = `
                        <div class="text-center text-gray-500 p-4" id="invoice-placeholder">
                            <span class="text-4xl">üßæ</span>
                            <p class="mt-2">Aguardando a busca de uma nota fiscal...</p>
                        </div>
                    `;
                }
            });
        }


        // Event listener para os bot√µes de a√ß√£o do menu principal
        actionButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const target = e.currentTarget.dataset.target;
                mainMenu.classList.add('hidden');
                contentSectionsContainer.classList.remove('hidden');
                showSection(target);
                // Dispara um evento personalizado para que a se√ß√£o possa carregar seus dados
                const event = new Event('section-visible');
                document.getElementById(target).dispatchEvent(event);
            });
        });

        // Event listener para o bot√£o de voltar ao menu
        backToMenuBtn.addEventListener('click', () => {
            // Esconde o container de conte√∫do e mostra o menu principal
            contentSectionsContainer.classList.add('hidden');
            mainMenu.classList.remove('hidden');

            // Reseta o estado das se√ß√µes
            document.getElementById('invoiceNumber').value = '';
            invoiceDetailsDiv.innerHTML = `
                <div class="text-center text-gray-500 p-4" id="invoice-placeholder">
                    <span class="text-4xl">üßæ</span>
                    <p class="mt-2">Aguardando a busca de uma nota fiscal...</p>
                </div>`;
        });
        
        // Dispara a carga de dados e setup das se√ß√µes ao carregar a p√°gina
        window.onload = function() {
            // N√£o √© necess√°rio carregar os dados aqui, pois cada se√ß√£o far√° isso de forma independente.
            setupRegisterClientSection();
            setupViewClientsSection();
            setupPromissorySalesSection();
            setupUpcomingDueDatesSection();
            setupStockControlSection();
            setupRegisterPaymentSection();
            setupInvoiceEntrySection();
        }
    </script>
</body>
</html>
